<html>
	<head>
		<title>Timetable Generator</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	</head>
	<body>
		<script type="text/javascript">
			var edit_entry_html = '\
			<div>\
				<label>Subject Name</label><input class="subject_input" type="text" value="{#name}" />\
				<label>Length (hours)</label><input class="time_input" type="text" value="{#hours}" />\
				<label>Repeat Class</label>\
				<select class="repeat_input">\
					<option value="-1"></option>\
					<option value="1">Monday</option>\
					<option value="2">Tuesday</option>\
					<option value="3">Wednesday</option>\
					<option value="4">Thursday</option>\
					<option value="5">Friday</option>\
				</select>\
				<button class="save_entry">Save Entry</button>\
			</div>';

			function decodeCoords( element )
			{
				// If the element is a jQuery object then convert to regular DOM
				if( element instanceof jQuery )
					element = element[ 0 ];
				
				var raw = element.className.replace( "x", "" ).replace( "y", "" ).split( " " );
				return { x: raw[ 0 ], y: raw[ 1 ] };
			}

			function colourGenerator( potential_colours )
			{
				map = {};
				index = 0;
				
				return function( name )
				{
					if( name == "" )
						return "white";
					else if( map[ name ] == undefined )
					{
						map[ name ] = potential_colours[ index ];
						index++;
						if( ( index + 1 ) > index.length )
							index = 0;
					}
					
					return "#" + map[ name ];
				};
			}
			colours = colourGenerator( [ "dce6f1", "fde9d9", "ebf1de", "daeef3" ] );

			function mapVerticalCells( start_cell, depth, aFunction )
			{
				var table = start_cell.parent().parent();
				var row = start_cell.parent();
				var row_num = table.children().index( row );
				var col_num = row.children().index( start_cell );
				
				if( isNaN( depth ) )
					throw "Depth (" + depth + ") is not a number";
				else
					depth = parseInt( depth );
				
				for( var i = depth; i > 1; i-- )
					aFunction( $( ".x" + ( row_num + i - 1 ) + ".y" + col_num ) );
			}
			
			/*
				repeat: can take on a number of values. When positive, it indicates the day on which the subject is to be repeated. If -1 then it indicates that no action should be taken. -2 indicates that the subject is the second in a repeating sequence.
			 */
			function enterSubject( cell, name, hours, repeat )
			{
				var hours = parseInt( hours );
				var repeat = parseInt( repeat );
				
				if( isNaN( hours ) || hours < 1 || hours > $( "#timetable tr" ).length )
					hours = 1;
				else if( hours > 1 )
					mapVerticalCells( cell, hours, function ( x ) { x.css( "display", "none" ); } );
				
				cell.html( name );				
				cell.attr( "rowspan", hours );
				cell.css( "background-color", colours( name ) );
								
				if( repeat > 1 )
				{
					var coords = decodeCoords( cell );
					
					// Make sure it's not the same column
					if( coords.y == repeat )
						return;

					enterSubject( $( ".x" + coords.x + ".y" + repeat ), name, hours, -2 );					
				}
			}

			function saveTimetable()
			{
				var tokens = $.map( $( "td" ), function( element )
				{	
					var name = $( element ).html().replace( /:\.,/m, "" );
					var length = $( element ).attr( "rowspan" );
					var coords = decodeCoords( element );

					/* There are some circumstances in which cell information need not be coded
						- The cell is blank (it is assumed that cells with empty names are blank).
						- The cell does not have a valid length (this should never occur).
						- The cell is a ghost cell, ie it is the second in a repeating sequence. This is handled in the originating cell.
					 */
					if( name == "" )
						return;

					var base_encoding = coords.x + ":" + coords.y + "," + name;
					
					if( length > 1 ) // include the length and the repeat
						base_encoding += "," + length;

					return base_encoding;
				} );
				c = tokens;
				return encodeURI( tokens.join( "." ) );
			}

			$( "td" ).live( "click", function( event )
			{
				var cell = $( event.currentTarget );

				// need to check event.target to prevent race conditions when saving
				if( cell.hasClass( "selected" ) == false && !$( event.target ).hasClass( "save_entry" ) )
				{
					if( cell.attr( "rowspan" ) > 1 )
					{
						mapVerticalCells( cell, cell.attr( "rowspan" ), function ( x ) { x.css( "display", "block" ); } );
						cell.attr( "rowspan", "1" );
					}

					cell.html( edit_entry_html.replace( "{#name}", cell.html() ).replace( "{#hours}", 1 ) ); // DIY templating :)
					cell.addClass( "selected" );
					cell[ 0 ].focus();
				}
			} );
			
			$( ".save_entry" ).live( "click", function( event )
			{
				var button = $( event.currentTarget );
				var cell = button.parent().parent();
				var subject_name = cell.children( ":first" ).children( ":nth-child(2)" ).val();
				var subject_hours = cell.children( ":first" ).children( ":nth-child(4)" ).val();
				var subject_repeat = cell.children( ":first" ).children( ":nth-child(6)" ).val();

				enterSubject( cell, subject_name, subject_hours, subject_repeat );
				
				cell.removeClass( "selected" );
				
				var url = $( location ).attr( "href" );
				if( url.match( /#.*?$/ ) )
					$( location ).attr( "href", url.replace( /#.*?$/, "#" + saveTimetable() ) );
				else
					$( location ).attr( "href", url + "#" + saveTimetable() );
			} );
			
			$( document ).ready( function()
			{
				var url = $( location ).attr( "href" );
				
				if( url.match( /#.*?$/ ) )
				{
					var raw = decodeURI( url.replace( /^.*?#/, "" ) );
					var cells = raw.split( "." )
					
					for( var i = 0; i < cells.length; i++ )
					{
						var values = cells[ i ].split( "," );
						var cords = values[ 0 ].split( ":" );
						var name = values[ 1 ];
						
						if( values.length <= 2 )
						{
							var length = 1;
							var repeat = -1;
						}
						else
						{
							var temp = values[ 2 ].split( "+" );							
							if( temp.length < 2 )
								temp[ 1 ] = -1;
							
							var length = temp[ 0 ];
							var repeat = temp[ 1 ]
						}
						
						enterSubject( $( ".x" + cords[ 0 ] + ".y" + cords[ 1 ] ), name, length, repeat );
					}
				}
			} );
			
		</script>
		<style type="text/css">
			#timetable
			{
				border-collapse: collapse;
				margin: 0 auto;
			}
			#timetable td, th
			{
				width: 100px;
				height: 40px;
				border: 2px solid black;
				text-align: center;
				vertical-align: middle;
			}
			#timetable th
			{
				background-color: #D3D3D3;
				font-family: Helvetica;
			}
			#timetable td
			{
				cursor: pointer;
			}
			.save_entry
			{
				margin-top: 10px;
			}
		</style>
		<h2>Chris' Amazing Timetable Maker</h2>
		<ul>
			<li>Click a timeslot to add a subject.</li>
			<li>Subjects will automatically be colour coded according to their name.</li>
			<li>The link to this page is updated each time you alter your timetable - you can share your timetable with others by copying it and giving it to them!</li>
		</ul>
		<table id="timetable">
			<tr>
				<th>
				</th>
				<th>Monday</th>
				<th>Tuesday</th>
				<th>Wednesday</th>
				<th>Thursday</th>
				<th>Friday</th>
			</tr>
			<tr>
				<th>9:00 AM</th>
				<td class="x1 y1"></td>
				<td class="x1 y2"></td>
				<td class="x1 y3"></td>
				<td class="x1 y4"></td>
				<td class="x1 y5"></td>
			</tr>
			<tr>
				<th>10:00 AM</th>
				<td class="x2 y1"></td>
				<td class="x2 y2"></td>
				<td class="x2 y3"></td>
				<td class="x2 y4"></td>
				<td class="x2 y5"></td>
			</tr>
			<tr>
				<th>11:00 AM</th>
				<td class="x3 y1"></td>
				<td class="x3 y2"></td>
				<td class="x3 y3"></td>
				<td class="x3 y4"></td>
				<td class="x3 y5"></td>
			</tr>
			<tr>
				<th>12 Noon</th>
				<td class="x4 y1"></td>
				<td class="x4 y2"></td>
				<td class="x4 y3"></td>
				<td class="x4 y4"></td>
				<td class="x4 y5"></td>
			</tr>
			<tr>
				<th>1:15 PM</th>
				<td class="x5 y1"></td>
				<td class="x5 y2"></td>
				<td class="x5 y3"></td>
				<td class="x5 y4"></td>
				<td class="x5 y5"></td>
			</tr>
			<tr>
				<th>2:15 PM</th>
				<td class="x6 y1"></td>
				<td class="x6 y2"></td>
				<td class="x6 y3"></td>
				<td class="x6 y4"></td>
				<td class="x6 y5"></td>
			</tr>
			<tr>
				<th>3:15 PM</th>
				<td class="x7 y1"></td>
				<td class="x7 y2"></td>
				<td class="x7 y3"></td>
				<td class="x7 y4"></td>
				<td class="x7 y5"></td>
			</tr>
			<tr>
				<th>4:15 PM</th>
				<td class="x8 y1"></td>
				<td class="x8 y2"></td>
				<td class="x8 y3"></td>
				<td class="x8 y4"></td>
				<td class="x8 y5"></td>
			</tr>
			<tr>
				<th>5:15 PM</th>
				<td class="x9 y1"></td>
				<td class="x9 y2"></td>
				<td class="x9 y3"></td>
				<td class="x9 y4"></td>
				<td class="x9 y5"></td>
			</tr>
		</table>
	</body>
</html>